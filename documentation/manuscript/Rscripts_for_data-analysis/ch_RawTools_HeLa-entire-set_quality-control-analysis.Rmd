---
title: "RawTools quality control output analysis"
output: html_notebook
---

This document details the analysis of quality control data generated using RawTools for analysis of the entire set of injections from HeLa set (n = 140). 

<br>

### Data analysis and plotting

<br>

These are the R libraries we will require.

```{r, results = 'hide'}
library(ggplot2)
library(cowplot)
library(RColorBrewer)
library(reshape2)
library(viridis)
```

<br>

First we need to get the QC output file generated by RawTools.

```{r}
###################################################################################################################################################################
#get the qc file
qc_data = read.table('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/qc_output_search4/QcDataTable.csv', header = TRUE, sep = ',')
qc_data$injection = sub(".*?Std_(.*?)\\.raw", "\\1", qc_data$FileName)
qc_data$injection = factor(qc_data$injection, levels = 1:140)
```

<br>

We can start plotting immediately here, looking at scan numbers first.

```{r}
###################################################################################################################################################################
#plot the scan numbers across replicates
qc_melt = melt(qc_data, id.var=c('injection'), measure.vars = c('TotalScans','NumMs1Scans','NumMs2Scans'))
output_plot = ggplot(qc_melt, aes(as.numeric(injection), value, fill = variable, group = variable)) +
  geom_point(pch = 21, size = 2, color = 'black', alpha = 0.6) +
  #geom_smooth(method = 'loess', se = FALSE, lty = 3) +
  scale_fill_manual(values = brewer.pal(4, "Set3")[c(1,3,4)]) +
  labs(x = "Injection Number", y = 'Number of Scans', title = 'Scan Numbers') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,12000), breaks = seq(0,12000,2000)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_scan-number-across-replicates.pdf',output_plot)
```

<br>

MS1 intensities.

```{r}
###################################################################################################################################################################
#plot the MS1 intensities across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), log10(Ms1MedianSummedIntensity))) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'log10(Median Summed MS1 Intensity)', title = 'MS1 Intensity') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,10), breaks = seq(0,10,1)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_MS1-intensity-across-replicates.pdf',output_plot)
```

<br>

MS2 intensities.

```{r}
###################################################################################################################################################################
#plot the MS2 intensities across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), log10(Ms2MedianSummedIntensity))) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'log10(Median Summed MS2 Intensity)', title = 'MS1 Intensity') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,10), breaks = seq(0,10,1)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_MS2-intensity-across-replicates.pdf',output_plot)
```

<br>

MS2 ion injection times.

```{r}
###################################################################################################################################################################
#plot the MS2 injection times across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), MedianMs2FillTime.ms.)) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'Median MS2 Ion Injection Time', title = 'MS2 Ion Injection Time') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,20), breaks = seq(0,20,2)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_MS2-injection-across-replicates.pdf',output_plot)
```

<br>

MS1 intensity as a chromatogram for fraction 23.

```{r}
###################################################################################################################################################################
#plot a line plot of MS1 intensities
qc_frac23 = read.table('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/raw/ch_23Aug2018_HeLa_Std_23.raw_Matrix.txt', header = TRUE, sep= '\t')

output_plot = ggplot(qc_frac23, aes(QuantScanRetTime, MS1MedianIntensity)) +
  geom_line(color = brewer.pal(3,'Set3')[1]) +
  labs(x = "Retention Time (minutes)", y = 'Median MS1 Intensity', title = 'MS1 Intensity Profile') +
  theme(axis.text.x = element_text(size = 9)) +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5)) +
  scale_y_continuous(limits = c(0,5e5), breaks = seq(0,5e5,1e5))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_fraction23_ms1-intensity.pdf',output_plot)
```

<br>

Use the `--chro` output of RawTools instead for the chromatogram plot.

```{r}

###################################################################################################################################################################
#plot a line plot of MS1 intensities using the chromatogram output of RawTools
qc_frac23 = read.table('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/raw/ch_23Aug2018_HeLa_Std_23.raw_Ms_BP_chromatogram.txt', header = TRUE, sep= '\t')

output_plot = ggplot(qc_frac23, aes(RetentionTime, Intensity)) +
  geom_line(color = brewer.pal(3,'Set3')[1]) +
  labs(x = "Retention Time (minutes)", y = 'MS1 Intensity', title = 'MS1 Intensity Profile') +
  theme(axis.text.x = element_text(size = 9)) +
  scale_x_continuous(limits = c(0,30), breaks = seq(0,30,5)) +
  scale_y_continuous(limits = c(0,8e8), breaks = seq(0,8e8,1e8))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_fraction23_ms1-intensity.pdf',output_plot)
```

<br>

Identification rate based on IdentiPy.

```{r}
###################################################################################################################################################################
#plot the identifcation rate across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), IdentificationRate.IDs.Ms2Scan.)) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'Spectra Identification Rate', title = 'Spectral Identification Rate') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.2)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_MS2-IDrate-across-replicates.pdf',output_plot)
```

<br>

ESI stability.

```{r}
###################################################################################################################################################################
#plot the esi stability across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), EsiInstabilityFlags.count.)) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'Number of MS1 Instability Counts', title = 'Electrospray Stability') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_esi-stability-across-replicates.pdf',output_plot)
```

<br>

Digestion efficiency.

```{r}
###################################################################################################################################################################
#plot the digestion efficiency across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), DigestionEfficiency)) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'Digestion Efficiency', title = 'Enzyme Digestion Efficiency') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,1), breaks = seq(0,1,0.2)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_digestion-efficiency-across-replicates.pdf',output_plot)
```

<br>

Frequency of oxidation events observed at Methionine.

```{r}
###################################################################################################################################################################
#plot the oxidation rate across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), ModificationFrequencyAtX)) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'Frequency of Oxidation', title = 'Methionine Oxidation Frequency') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,0.5), breaks = seq(0,0.5,0.1)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_methionine-oxidation-across-replicates.pdf',output_plot)
```

<br>

Lastly, the error in the mass analyzer based on the IdentiPy results.

```{r}
###################################################################################################################################################################
#plot the mass drift across replicates
output_plot = ggplot(qc_data, aes(as.numeric(injection), abs(MedianMassDrift.ppm.))) +
  geom_point(fill = brewer.pal(3,'Set3')[1], pch = 21, size = 2, colour = 'black', alpha = 0.6) +
  labs(x = "Injection Number", y = 'Median Mass Error (ppm)', title = 'Mass Analyzer Accuracy') +
  theme(axis.text.x = element_text(size = 9), legend.position="none") +
  scale_y_continuous(limits = c(0,6), breaks = seq(0,6,1)) +
  scale_x_continuous(limits = c(0,140), breaks = seq(0,140,20))
output_plot
save_plot('/projects/ptx_analysis/chughes/projects-current/morin_rawtools/qc_testing/Ranalysis/QC_mass-drift-across-replicates.pdf',output_plot)
```

<br>

Done.


